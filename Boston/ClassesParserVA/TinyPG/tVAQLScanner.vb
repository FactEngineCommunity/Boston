' Generated by TinyPG v1.3 available at www.codeproject.com

Imports System
Imports System.Collections.Generic
Imports System.Text.RegularExpressions
Imports System.Xml.Serialization


Namespace VAQL
#Region "Scanner"

    Partial Public Class Scanner
        Public Input As String
        Public StartPos As Integer = 0
        Public EndPos As Integer = 0
        Public CurrentLine As Integer
        Public CurrentColumn As Integer
        Public CurrentPosition As Integer
        Public Skipped As List(Of Token) ' tokens that were skipped
        Public Patterns As Dictionary(Of TokenType, Regex)

        Private LookAheadToken As Token
        Private Tokens As List(Of TokenType)
        Private SkipList As List(Of TokenType) ' tokens to be skipped

        Public Sub New()
            Dim regex As Regex
            Patterns = New Dictionary(Of TokenType, Regex)()
            Tokens = New List(Of TokenType)()
            LookAheadToken = Nothing
            Skipped = New List(Of Token)()

            SkipList = New List(Of TokenType)()
            SkipList.Add(TokenType.WHITESPACE)

            regex = new Regex("\(+", RegexOptions.Compiled)
            Patterns.Add(TokenType.BROPEN, regex)
            Tokens.Add(TokenType.BROPEN)

            regex = new Regex("\)+", RegexOptions.Compiled)
            Patterns.Add(TokenType.BRCLOSE, regex)
            Tokens.Add(TokenType.BRCLOSE)

            regex = new Regex(":", RegexOptions.Compiled)
            Patterns.Add(TokenType.COLON, regex)
            Tokens.Add(TokenType.COLON)

            regex = new Regex("[aA-zZ0-9]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.COLUMNNAMESTR, regex)
            Tokens.Add(TokenType.COLUMNNAMESTR)

            regex = new Regex(",", RegexOptions.Compiled)
            Patterns.Add(TokenType.COMMA, regex)
            Tokens.Add(TokenType.COMMA)

            regex = new Regex("\}+", RegexOptions.Compiled)
            Patterns.Add(TokenType.CURLYBRACKETCLOSE, regex)
            Tokens.Add(TokenType.CURLYBRACKETCLOSE)

            regex = new Regex("\{+", RegexOptions.Compiled)
            Patterns.Add(TokenType.CURLYBRACKETOPEN, regex)
            Tokens.Add(TokenType.CURLYBRACKETOPEN)

            regex = new Regex("""", RegexOptions.Compiled)
            Patterns.Add(TokenType.DOUBLEQUOTE, regex)
            Tokens.Add(TokenType.DOUBLEQUOTE)

            regex = new Regex("^$", RegexOptions.Compiled)
            Patterns.Add(TokenType.EOF, regex)
            Tokens.Add(TokenType.EOF)

            regex = new Regex("=", RegexOptions.Compiled)
            Patterns.Add(TokenType.EQUALS, regex)
            Tokens.Add(TokenType.EQUALS)

            regex = new Regex("[aA-zZ]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.FACTTYPENAME, regex)
            Tokens.Add(TokenType.FACTTYPENAME)

            regex = new Regex("[a-z|\s]+$", RegexOptions.Compiled)
            Patterns.Add(TokenType.FOLLOWINGREADINGTEXT, regex)
            Tokens.Add(TokenType.FOLLOWINGREADINGTEXT)

            regex = new Regex("(?>[a-z]+)[^\-]", RegexOptions.Compiled)
            Patterns.Add(TokenType.FRONTREADINGTEXT, regex)
            Tokens.Add(TokenType.FRONTREADINGTEXT)

            regex = new Regex("[aA-zZ0-9]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.ID, regex)
            Tokens.Add(TokenType.ID)

            regex = new Regex("\*|/", RegexOptions.Compiled)
            Patterns.Add(TokenType.MULTDIV, regex)
            Tokens.Add(TokenType.MULTDIV)

            regex = new Regex("[aA-zZ]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.MODELNAME, regex)
            Tokens.Add(TokenType.MODELNAME)

            regex = new Regex("(((?!(IS|WRITTEN|TO|INCLUDES))[A-Z0-9]+[_a-z\-0-9]*[ |_]*)+[_|\s]?)+", RegexOptions.Compiled)
            Patterns.Add(TokenType.MODELELEMENTNAME, regex)
            Tokens.Add(TokenType.MODELELEMENTNAME)

            regex = new Regex("[0-9]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.NUMBER, regex)
            Tokens.Add(TokenType.NUMBER)

            regex = new Regex("\.", RegexOptions.Compiled)
            Patterns.Add(TokenType.PERIOD, regex)
            Tokens.Add(TokenType.PERIOD)

            regex = new Regex("(\+|-)", RegexOptions.Compiled)
            Patterns.Add(TokenType.PLUSMINUS, regex)
            Tokens.Add(TokenType.PLUSMINUS)

            regex = new Regex("([aA-zZ0-9\-]+[_|\s]?)+", RegexOptions.Compiled)
            Patterns.Add(TokenType.PAGENAME, regex)
            Tokens.Add(TokenType.PAGENAME)

            regex = new Regex("\-[a-z]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.POSTBOUNDREADINGTEXT, regex)
            Tokens.Add(TokenType.POSTBOUNDREADINGTEXT)

            regex = new Regex("[a-z]+\-", RegexOptions.Compiled)
            Patterns.Add(TokenType.PREBOUNDREADINGTEXT, regex)
            Tokens.Add(TokenType.PREBOUNDREADINGTEXT)

            regex = new Regex("(?!([a-z]+\-))(?!([a-z]+$))([a-z]+[^\-])", RegexOptions.Compiled)
            Patterns.Add(TokenType.PREDICATEPART, regex)
            Tokens.Add(TokenType.PREDICATEPART)

            regex = new Regex("[\s]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.PREDICATESPACE, regex)
            Tokens.Add(TokenType.PREDICATESPACE)

            regex = new Regex("[A-Z][aA-zZ]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.REFERENCEMODE, regex)
            Tokens.Add(TokenType.REFERENCEMODE)

            regex = new Regex("[a-z]+\-?", RegexOptions.Compiled)
            Patterns.Add(TokenType.ROLENAME, regex)
            Tokens.Add(TokenType.ROLENAME)

            regex = new Regex("'", RegexOptions.Compiled)
            Patterns.Add(TokenType.SINGLEQUOTE, regex)
            Tokens.Add(TokenType.SINGLEQUOTE)

            regex = new Regex("\*", RegexOptions.Compiled)
            Patterns.Add(TokenType.STAR, regex)
            Tokens.Add(TokenType.STAR)

            regex = new Regex("\s", RegexOptions.Compiled)
            Patterns.Add(TokenType.SPACE, regex)
            Tokens.Add(TokenType.SPACE)

            regex = new Regex("((?>[a-z])+[\s]?)+$", RegexOptions.Compiled)
            Patterns.Add(TokenType.UNARYPREDICATEPART, regex)
            Tokens.Add(TokenType.UNARYPREDICATEPART)

            regex = new Regex("[aA-zZ0-9]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.USERTABLENAME, regex)
            Tokens.Add(TokenType.USERTABLENAME)

            regex = new Regex("^(?!\s)[aA-zZ0-9%\*\+\?\!&\.\(\) \-\:/]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.VALUECONSTRAINTVALUE, regex)
            Tokens.Add(TokenType.VALUECONSTRAINTVALUE)

            regex = new Regex("[aA-zZ0-9]+", RegexOptions.Compiled)
            Patterns.Add(TokenType.WHERECLAUSECOLUMNNAMESTR, regex)
            Tokens.Add(TokenType.WHERECLAUSECOLUMNNAMESTR)

            regex = new Regex("^[^-\s][aA-zZ0-9\-\s+\#\*\?]*", RegexOptions.Compiled)
            Patterns.Add(TokenType.VALUE, regex)
            Tokens.Add(TokenType.VALUE)

            regex = new Regex("ADD OBJECT TYPE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDADDOBJECTTYPE, regex)
            Tokens.Add(TokenType.KEYWDADDOBJECTTYPE)

            regex = new Regex("ADD OBJECT TYPES RELATED TO", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDADDOBJECTTYPESRELATEDTO, regex)
            Tokens.Add(TokenType.KEYWDADDOBJECTTYPESRELATEDTO)

            regex = new Regex("ANY NUMBER OF", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDANYNUMBEROF, regex)
            Tokens.Add(TokenType.KEYWDANYNUMBEROF)

            regex = new Regex("ANY FACT TYPE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDANYFACTTYPE, regex)
            Tokens.Add(TokenType.KEYWDANYFACTTYPE)

            regex = new Regex("AT LEAST ONE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDATLEASTONE, regex)
            Tokens.Add(TokenType.KEYWDATLEASTONE)

            regex = new Regex("AT MOST ONE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDATMOSTONE, regex)
            Tokens.Add(TokenType.KEYWDATMOSTONE)

            regex = new Regex("CREATE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDCREATE, regex)
            Tokens.Add(TokenType.KEYWDCREATE)

            regex = new Regex("INCLUDES", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDINCLUDES, regex)
            Tokens.Add(TokenType.KEYWDINCLUDES)

            regex = new Regex("IS A", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISA, regex)
            Tokens.Add(TokenType.KEYWDISA)

            regex = new Regex("IS WHERE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISWHERE, regex)
            Tokens.Add(TokenType.KEYWDISWHERE)

            regex = new Regex("LogicalTrueFalse", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPELOGICALTRUEFALSE, regex)
            Tokens.Add(TokenType.KEYWDDATATYPELOGICALTRUEFALSE)

            regex = new Regex("LogicalYesNo", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPELOGICALYESNO, regex)
            Tokens.Add(TokenType.KEYWDDATATYPELOGICALYESNO)

            regex = new Regex("AutoCounter", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEAUTOCOUNTER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEAUTOCOUNTER)

            regex = new Regex("Decimal", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEDECIMAL, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEDECIMAL)

            regex = new Regex("FloatCustomPrecision", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEFLOATCUSTOMPRECISION, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEFLOATCUSTOMPRECISION)

            regex = new Regex("FloatDoublePrecision", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEFLOATDOUBLEPRECISION, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEFLOATDOUBLEPRECISION)

            regex = new Regex("FloatSinglePrecision", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEFLOATSINGLEPRECISION, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEFLOATSINGLEPRECISION)

            regex = new Regex("Money", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEMONEY, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEMONEY)

            regex = new Regex("SignedBigInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPESIGNEDBIGINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPESIGNEDBIGINTEGER)

            regex = new Regex("SignedInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPESIGNEDINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPESIGNEDINTEGER)

            regex = new Regex("SignedSmallInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPESIGNEDSMALLINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPESIGNEDSMALLINTEGER)

            regex = new Regex("UnsignedBigInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEUNSIGNEDBIGINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEUNSIGNEDBIGINTEGER)

            regex = new Regex("UnsignedInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEUNSIGNEDINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEUNSIGNEDINTEGER)

            regex = new Regex("UnsignedSmallInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEUNSIGNEDSMALLINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEUNSIGNEDSMALLINTEGER)

            regex = new Regex("UnsignedTinyInteger", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEUNSIGNEDTINYINTEGER, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEUNSIGNEDTINYINTEGER)

            regex = new Regex("ObjectID", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEOBJECTID, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEOBJECTID)

            regex = new Regex("RowID", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEROWID, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEROWID)

            regex = new Regex("RawDataFixedLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPERAWDATAFIXEDLENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPERAWDATAFIXEDLENGTH)

            regex = new Regex("RawDataLargeLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPERAWDATALARGELENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPERAWDATALARGELENGTH)

            regex = new Regex("RawDataOLEObject", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPERAWDATAOLEOBJECT, regex)
            Tokens.Add(TokenType.KEYWDDATATYPERAWDATAOLEOBJECT)

            regex = new Regex("RawDataPicture", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPERAWDATA, regex)
            Tokens.Add(TokenType.KEYWDDATATYPERAWDATA)

            regex = new Regex("VariableLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPERAWDATAVARIABLELENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPERAWDATAVARIABLELENGTH)

            regex = new Regex("AutoTimestamp", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEAUTOTIMESTAMP, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEAUTOTIMESTAMP)

            regex = new Regex("Date", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEDATE, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEDATE)

            regex = new Regex("TemporalDateTime", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPEDATETIME, regex)
            Tokens.Add(TokenType.KEYWDDATATYPEDATETIME)

            regex = new Regex("TemporalTime", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPETIME, regex)
            Tokens.Add(TokenType.KEYWDDATATYPETIME)

            regex = new Regex("StringFixedLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPESTRINGFIXEDLENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPESTRINGFIXEDLENGTH)

            regex = new Regex("StringLargeLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPESTRINGLARGELENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPESTRINGLARGELENGTH)

            regex = new Regex("StringVariableLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPESTRINGVARIABLELENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPESTRINGVARIABLELENGTH)

            regex = new Regex("TextFixedLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPETEXTFIXEDLENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPETEXTFIXEDLENGTH)

            regex = new Regex("TextLargeLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPETEXTLARGELENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPETEXTLARGELENGTH)

            regex = new Regex("TextVariableLength", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDDATATYPETEXTVARIABLELENGTH, regex)
            Tokens.Add(TokenType.KEYWDDATATYPETEXTVARIABLELENGTH)

            regex = new Regex("IDENTIFIED BY", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDIDENTIFIEDBY, regex)
            Tokens.Add(TokenType.KEYWDIDENTIFIEDBY)

            regex = new Regex("IS A CONCEPT", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISACONCEPT, regex)
            Tokens.Add(TokenType.KEYWDISACONCEPT)

            regex = new Regex("IS A KIND OF", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISAKINDOF, regex)
            Tokens.Add(TokenType.KEYWDISAKINDOF)

            regex = new Regex("IS AN ENTITY TYPE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISANENTITYTYPE, regex)
            Tokens.Add(TokenType.KEYWDISANENTITYTYPE)

            regex = new Regex("IS A VALUE TYPE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISAVALUETYPE, regex)
            Tokens.Add(TokenType.KEYWDISAVALUETYPE)

            regex = new Regex("IS IDENTIFIED BY", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISIDENTIFIEDBY, regex)
            Tokens.Add(TokenType.KEYWDISIDENTIFIEDBY)

            regex = new Regex("IS OBJECTIFIED", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISOBJECTIFIED, regex)
            Tokens.Add(TokenType.KEYWDISOBJECTIFIED)

            regex = new Regex("IS WRITTEN AS", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDISWRITTENAS, regex)
            Tokens.Add(TokenType.KEYWDISWRITTENAS)

            regex = new Regex("ITS", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDITS, regex)
            Tokens.Add(TokenType.KEYWDITS)

            regex = new Regex("NL:", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDNL, regex)
            Tokens.Add(TokenType.KEYWDNL)

            regex = new Regex("ONE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDONE, regex)
            Tokens.Add(TokenType.KEYWDONE)

            regex = new Regex("PAGE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDPAGE, regex)
            Tokens.Add(TokenType.KEYWDPAGE)

            regex = new Regex("READING", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDREADING, regex)
            Tokens.Add(TokenType.KEYWDREADING)

            regex = new Regex("TO PAGE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDTOPAGE, regex)
            Tokens.Add(TokenType.KEYWDTOPAGE)

            regex = new Regex("STAND ALONE", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDSTANDALONE, regex)
            Tokens.Add(TokenType.KEYWDSTANDALONE)

            regex = new Regex("THEIR", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDTHEIR, regex)
            Tokens.Add(TokenType.KEYWDTHEIR)

            regex = new Regex("WRITTEN AS", RegexOptions.Compiled)
            Patterns.Add(TokenType.KEYWDWRITTENAS, regex)
            Tokens.Add(TokenType.KEYWDWRITTENAS)

            regex = new Regex("\s+", RegexOptions.Compiled)
            Patterns.Add(TokenType.WHITESPACE, regex)
            Tokens.Add(TokenType.WHITESPACE)



        End Sub

        Public Sub Init(ByVal input As String)
            Me.Input = input
            StartPos = 0
            EndPos = 0
            CurrentLine = 0
            CurrentColumn = 0
            CurrentPosition = 0
            Skipped = New List(Of Token)()
            LookAheadToken = Nothing
        End Sub

        Public Function GetToken(ByVal type As TokenType) As Token
            Dim t As New Token(Me.StartPos, Me.EndPos)
            t.Type = type
            Return t
        End Function

        ''' <summary>
        ''' executes a lookahead of the next token
        ''' and will advance the scan on the input string
        ''' </summary>
        ''' <returns></returns>
        Public Function Scan(ByVal ParamArray expectedtokens As TokenType()) As Token
            Dim tok As Token = LookAhead(expectedtokens)
            ' temporarely retrieve the lookahead
            LookAheadToken = Nothing
            ' reset lookahead token, so scanning will continue
            StartPos = tok.EndPos
            EndPos = tok.EndPos
            ' set the tokenizer to the new scan position
            Return tok
        End Function

        ''' <summary>
        ''' returns token with longest best match
        ''' </summary>
        ''' <returns></returns>
        Public Function LookAhead(ByVal ParamArray expectedtokens As TokenType()) As Token
            Dim i As Integer
            Dim start As Integer = StartPos
            Dim tok As Token = Nothing
            Dim scantokens As List(Of TokenType)

            ' this prevents double scanning and matching
            ' increased performance
            If LookAheadToken IsNot Nothing AndAlso LookAheadToken.Type <> TokenType._UNDETERMINED_ AndAlso LookAheadToken.Type <> TokenType._NONE_ Then
                Return LookAheadToken
            End If

            If expectedtokens.Length = 0 Then
                scantokens = Tokens
            Else
                scantokens = New List(Of TokenType)(expectedtokens)
                scantokens.AddRange(SkipList)
            End If

            Do
                Dim len As Integer = -1
                Dim index As TokenType = Integer.MaxValue
                Dim m_input As String

                If start > Input.Length Then
                    tok = New Token(start, start)
                    tok.Type = TokenType._UNDETERMINED_
                    Exit Do
                End If

                m_input = Input.Substring(start)

                tok = New Token(start, EndPos)


                For i = 0 To scantokens.Count - 1
                    Dim r As Regex = Patterns(scantokens(i))
                    Dim m As Match = r.Match(m_input)
                    If m.Success AndAlso m.Index = 0 AndAlso ((m.Length > len) OrElse (scantokens(i) < index AndAlso m.Length = len)) Then
                        len = m.Length
                        index = scantokens(i)
                        Exit For
                    End If
                Next i

                If index >= 0 AndAlso len >= 0 Then
                    tok.EndPos = start + len
                    If tok.StartPos + len <= Input.Length Then
                        tok.Text = Input.Substring(tok.StartPos, len)
                    End If
                    tok.Type = index
                Else
                    If tok.StartPos < tok.EndPos - 1 Then
                        tok.Text = Input.Substring(tok.StartPos, 1)
                    End If
                End If

                If SkipList.Contains(tok.Type) Then
                    start = tok.EndPos
                    Skipped.Add(tok)
                Else
                    tok.Skipped = Skipped
                    Skipped = New List(Of Token)
                End If
            Loop While SkipList.Contains(tok.Type)

            LookAheadToken = tok
            Return tok
        End Function
    End Class
#End Region

#Region "Token"

    Public Enum TokenType

        'Non terminal tokens:
        _NONE_      = 0
        _UNDETERMINED_= 1

        'Non terminal tokens:
        ADDITIONALVALUE= 2
        VALUELIST   = 3
        VALUESTRING = 4
        NATURALLANGUAGEPROMPT= 5
        ADDITIONALVALUECONSTRAINTVALUE= 6
        BINARYFACTTYPEANYNUMBEROFCLAUSE= 7
        BINARYFACTTYPEATLEASTONECLAUSE= 8
        BINARYFACTTYPEATMOSTONECLAUSE= 9
        BINARYFACTTYPEMANYTOONEDEFINITIONCLAUSE= 10
        BINARYPREDICATECLAUSE= 11
        DATATYPE    = 12
        DATATYPELENGTH= 13
        DATATYPEPRECISION= 14
        ENTITYTYPEISIDENTIFIEDBYITSCLAUSE= 15
        ENTITYTYPEIDENTIFIEDBYITSCLAUSE= 16
        FACTCLAUSE  = 17
        FACTTYPECLAUSE= 18
        FRONTREADINGTEXTCLAUSE= 19
        IDENTIFIERMODELELEMENT= 20
        ISACONCEPTCLAUSE= 21
        ISANENTITYTYPECLAUSE= 22
        ISAVALUETYPECLAUSE= 23
        ISOBJECTIFIEDCLAUSE= 24
        ISWHERECLAUSE= 25
        MODELELEMENT= 26
        MODELELEMENTTYPE= 27
        OBJECTIFIEDFACTTYPEISIDENTIFIEDBYITSCLAUSE= 28
        PREDICATECLAUSE= 29
        QUOTEDMODELELEMENTNAME= 30
        UNARYPREDICATECLAUSE= 31
        VALUECONSTRAINTCLAUSE= 32
        VALUECONSTRAINTVALUELIST= 33
        VALUETYPEISWRITTENASCLAUSE= 34
        VALUETYPEWRITTENASCLAUSE= 35
        ADDOBJECTTYPESRELATEDTOMODELELEMENTTOPAGESTMT= 36
        ADDOBJECTTYPETOPAGESTMT= 37
        CREATEPAGESTMT= 38
        CREATESTMT  = 39
        FACTSTMT    = 40
        FACTTYPEIDENTIFICATION= 41
        FACTTYPESTMT= 42
        FACTREADINGSTMT= 43
        MODELELEMENTLEADINGSTMT= 44
        BASEPRODUCTION= 45
        Start       = 46

        'Terminal tokens:
        BROPEN      = 47
        BRCLOSE     = 48
        COLON       = 49
        COLUMNNAMESTR= 50
        COMMA       = 51
        CURLYBRACKETCLOSE= 52
        CURLYBRACKETOPEN= 53
        DOUBLEQUOTE = 54
        EOF         = 55
        EQUALS      = 56
        FACTTYPENAME= 57
        FOLLOWINGREADINGTEXT= 58
        FRONTREADINGTEXT= 59
        ID          = 60
        MULTDIV     = 61
        MODELNAME   = 62
        MODELELEMENTNAME= 63
        NUMBER      = 64
        PERIOD      = 65
        PLUSMINUS   = 66
        PAGENAME    = 67
        POSTBOUNDREADINGTEXT= 68
        PREBOUNDREADINGTEXT= 69
        PREDICATEPART= 70
        PREDICATESPACE= 71
        REFERENCEMODE= 72
        ROLENAME    = 73
        SINGLEQUOTE = 74
        STAR        = 75
        SPACE       = 76
        UNARYPREDICATEPART= 77
        USERTABLENAME= 78
        VALUECONSTRAINTVALUE= 79
        WHERECLAUSECOLUMNNAMESTR= 80
        VALUE       = 81
        KEYWDADDOBJECTTYPE= 82
        KEYWDADDOBJECTTYPESRELATEDTO= 83
        KEYWDANYNUMBEROF= 84
        KEYWDANYFACTTYPE= 85
        KEYWDATLEASTONE= 86
        KEYWDATMOSTONE= 87
        KEYWDCREATE = 88
        KEYWDINCLUDES= 89
        KEYWDISA    = 90
        KEYWDISWHERE= 91
        KEYWDDATATYPELOGICALTRUEFALSE= 92
        KEYWDDATATYPELOGICALYESNO= 93
        KEYWDDATATYPEAUTOCOUNTER= 94
        KEYWDDATATYPEDECIMAL= 95
        KEYWDDATATYPEFLOATCUSTOMPRECISION= 96
        KEYWDDATATYPEFLOATDOUBLEPRECISION= 97
        KEYWDDATATYPEFLOATSINGLEPRECISION= 98
        KEYWDDATATYPEMONEY= 99
        KEYWDDATATYPESIGNEDBIGINTEGER= 100
        KEYWDDATATYPESIGNEDINTEGER= 101
        KEYWDDATATYPESIGNEDSMALLINTEGER= 102
        KEYWDDATATYPEUNSIGNEDBIGINTEGER= 103
        KEYWDDATATYPEUNSIGNEDINTEGER= 104
        KEYWDDATATYPEUNSIGNEDSMALLINTEGER= 105
        KEYWDDATATYPEUNSIGNEDTINYINTEGER= 106
        KEYWDDATATYPEOBJECTID= 107
        KEYWDDATATYPEROWID= 108
        KEYWDDATATYPERAWDATAFIXEDLENGTH= 109
        KEYWDDATATYPERAWDATALARGELENGTH= 110
        KEYWDDATATYPERAWDATAOLEOBJECT= 111
        KEYWDDATATYPERAWDATA= 112
        KEYWDDATATYPERAWDATAVARIABLELENGTH= 113
        KEYWDDATATYPEAUTOTIMESTAMP= 114
        KEYWDDATATYPEDATE= 115
        KEYWDDATATYPEDATETIME= 116
        KEYWDDATATYPETIME= 117
        KEYWDDATATYPESTRINGFIXEDLENGTH= 118
        KEYWDDATATYPESTRINGLARGELENGTH= 119
        KEYWDDATATYPESTRINGVARIABLELENGTH= 120
        KEYWDDATATYPETEXTFIXEDLENGTH= 121
        KEYWDDATATYPETEXTLARGELENGTH= 122
        KEYWDDATATYPETEXTVARIABLELENGTH= 123
        KEYWDIDENTIFIEDBY= 124
        KEYWDISACONCEPT= 125
        KEYWDISAKINDOF= 126
        KEYWDISANENTITYTYPE= 127
        KEYWDISAVALUETYPE= 128
        KEYWDISIDENTIFIEDBY= 129
        KEYWDISOBJECTIFIED= 130
        KEYWDISWRITTENAS= 131
        KEYWDITS    = 132
        KEYWDNL     = 133
        KEYWDONE    = 134
        KEYWDPAGE   = 135
        KEYWDREADING= 136
        KEYWDTOPAGE = 137
        KEYWDSTANDALONE= 138
        KEYWDTHEIR  = 139
        KEYWDWRITTENAS= 140
        WHITESPACE  = 141
    End Enum

    <Serializable()>
    Public Class Token 
        Implements ICloneable

        Private m_startPos As Integer
        Private m_endPos As Integer
        Private m_text As String
        Private m_value As Object

        ' contains all prior skipped symbols
        Private m_skipped As List(Of Token)


        Public Property StartPos() As Integer
            Get
                Return m_startPos
            End Get
            Set(ByVal value As Integer)
                m_startPos = value
            End Set
        End Property

        Public Property EndPos() As Integer
            Get
                Return m_endPos
            End Get
            Set(ByVal value As Integer)
                m_endPos = value
            End Set
        End Property

        Public ReadOnly Property Length() As Integer
            Get
                Return m_endPos - m_startPos
            End Get
        End Property

        Public Property Text() As String
            Get
                Return m_text
            End Get
            Set(ByVal value As String)
                m_text = value
            End Set
        End Property

        Public Property Skipped() As List(Of Token)
            Get
                Return m_skipped
            End Get
            Set(ByVal value As List(Of Token))
                m_skipped = value
            End Set
        End Property

        Public Property Value() As Object
            Get
                Return m_value
            End Get
            Set(ByVal value As Object)
                Me.m_value = value
            End Set
        End Property

        <XmlAttribute()>
        Public Type As TokenType

        Public Sub New()
            Me.New(0, 0)
        End Sub

        Public Sub New(ByVal start As Integer, ByVal endPos As Integer)
            Type = TokenType._UNDETERMINED_
            m_startPos = start
            m_endPos = endPos
            Text = ""
            ' must initialize with empty string, may cause null reference exceptions otherwise
            Value = Nothing
        End Sub

        Public Sub UpdateRange(ByVal token As Token)
            If token.StartPos < m_startPos Then
                m_startPos = token.StartPos
            End If
            If token.EndPos > m_endPos Then
                m_endPos = token.EndPos
            End If
        End Sub

        Public Overloads Overrides Function ToString() As String
            If Text <> Nothing Then
                Return Type.ToString() + " '" + Text + "'"
            Else
                Return Type.ToString()
            End If
        End Function

        Public Function Clone() As Object Implements ICloneable.Clone
            Dim lrToken As New Token
            Dim lrSkippedToken As Token
            With Me
                lrToken.m_startPos = .m_startPos
                lrToken.m_endPos = .m_endPos
                lrToken.m_text = .m_text
                lrToken.m_value = .m_value
                lrToken.Type = .Type

                ' contains all prior skipped symbols
                If .m_skipped IsNot Nothing Then
                    lrToken.m_skipped = New List(Of Token)
                    For Each lrSkippedToken In .m_skipped
                        lrToken.m_skipped.Add(lrSkippedToken.Clone)
                    Next
                End If
            End With

            Return lrToken
        End Function

    End Class
#End Region
End Namespace
