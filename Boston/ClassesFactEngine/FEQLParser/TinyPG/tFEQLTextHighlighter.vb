' Generated by TinyPG v1.3 available at www.codeproject.com

Imports Microsoft.VisualBasic
Imports System
Imports System.Collections.Generic
Imports System.Text
Imports System.Windows.Forms
Imports System.Runtime.InteropServices
Imports System.Drawing
Imports System.Threading

Namespace FEQL
    ' Summary:
    '     System.EventArgs is the base class for classes containing event data.
    <Serializable()> _
    <ComVisible(True)> _
    Public Class ContextSwitchEventArgs
        Inherits EventArgs
        Public ReadOnly PreviousContext As ParseNode
        Public ReadOnly NewContext As ParseNode

        ' Summary:
        '     Initializes a new instance of the System.EventArgs class.
        Public Sub New(ByVal prevContext As ParseNode, ByVal nextContext As ParseNode)
            PreviousContext = prevContext
            NewContext = nextContext
        End Sub
    End Class

    ' delegate for firing context switch events
    Public Delegate Sub ContextSwitchEventHandler(ByVal sender As Object, ByVal e As ContextSwitchEventArgs)

    ''' <summary>
    ''' Takes control over the RichTextBox and will color the text accoording to the rules of the parser and the scanner
    ''' this control extender will also support Undo/Redo functionality.
    ''' </summary>
    Public Class TextHighlighter
        Implements IDisposable
        Private Class UndoItem
            ''' <summary>
            ''' contains the information for an undo/redo action
            ''' </summary>
            ''' <param name="text">the full text to be undone/redone</param>
            ''' <param name="position">position of the caret after the un/redo action</param>
            ''' <param name="scroll">position of the scrollbars after un/redo action</param>
            Public Sub New(ByVal text As String, ByVal position As Integer, ByVal scroll As Point)
                Me.Text = text
                Me.Position = position
                Me.ScrollPosition = scroll
            End Sub

            Public Text As String
            Public Position As Integer
            Public ScrollPosition As Point
        End Class


        ' some winap√≠s required
        <DllImport("user32", CharSet:=CharSet.Auto)> _
        Private Shared Function SendMessage(ByVal hWnd As IntPtr, ByVal msg As Integer, ByVal wParam As Integer, ByVal lParam As IntPtr) As IntPtr
        End Function

        <DllImport("user32.dll")> _
        Private Shared Function PostMessageA(ByVal hWnd As IntPtr, ByVal nBar As Integer, ByVal wParam As Integer, ByVal lParam As Integer) As Boolean
        End Function

        <DllImport("user32.dll", CharSet:=CharSet.Auto)> _
        Private Shared Function GetScrollPos(ByVal hWnd As Integer, ByVal nBar As Integer) As Integer
        End Function

        <DllImport("user32.dll")> _
        Private Shared Function SetScrollPos(ByVal hWnd As IntPtr, ByVal nBar As Integer, ByVal nPos As Integer, ByVal bRedraw As Boolean) As Integer
        End Function

        Private Const WM_SETREDRAW As Integer = 11
        Private Const WM_USER As Integer = 1024
        Private Const EM_GETEVENTMASK As Integer = (WM_USER + 59)
        Private Const EM_SETEVENTMASK As Integer = (WM_USER + 69)
        Private Const SB_HORZ As Integer = 0
        Private Const SB_VERT As Integer = 1
        Private Const WM_HSCROLL As Integer = 276
        Private Const WM_VSCROLL As Integer = 277
        Private Const SB_THUMBPOSITION As Integer = 4
        Private Const UNDO_BUFFER As Integer = 100

        Private Property HScrollPos() As Integer
            Get
                Return GetScrollPos(Textbox.Handle.ToInt32(), SB_HORZ)
            End Get
            Set(ByVal value As Integer)
                SetScrollPos(DirectCast(Textbox.Handle, IntPtr), SB_HORZ, value, True)
                PostMessageA(DirectCast(Textbox.Handle, IntPtr), WM_HSCROLL, SB_THUMBPOSITION + 65536 * value, 0)
            End Set
        End Property

        Private Property VScrollPos() As Integer
            Get
                Return GetScrollPos(Textbox.Handle.ToInt32(), SB_VERT)
            End Get
            Set(ByVal value As Integer)
                SetScrollPos(DirectCast(Textbox.Handle, IntPtr), SB_VERT, value, True)
                PostMessageA(DirectCast(Textbox.Handle, IntPtr), WM_VSCROLL, SB_THUMBPOSITION + 65536 * value, 0)
            End Set
        End Property

        ' public shared members
        Public Tree As ParseTree
        Public ReadOnly Textbox As RichTextBox

        ' private members
        Private Parser As Parser
        Private Scanner As Scanner
        Private stateLocked As IntPtr = IntPtr.Zero

        Private UndoIndex As Integer = -1
        Private UndoList As List(Of UndoItem)

        Private currentContext As ParseNode
        Public Event SwitchContext As ContextSwitchEventHandler
        Public Event KeyDown(ByVal sender As Object, ByVal e As KeyEventArgs)

        Private threadAutoHighlight As Thread


        Private Sub DoAction(ByVal text As String, ByVal position As Integer)

            If stateLocked <> IntPtr.Zero Then
                Return
            End If

            Dim ua As New UndoItem(text, position, New Point(HScrollPos, VScrollPos))
            UndoList.RemoveRange(UndoIndex, UndoList.Count - UndoIndex)
            UndoList.Add(ua)
            If UndoList.Count > UNDO_BUFFER Then
                UndoList.RemoveAt(0)
            End If

            ' make undo/redo a little smarter, remove single strokes
            ' reducing nr of undo states
            If UndoList.Count > 7 Then
                Dim canRemove As Boolean = True
                Dim nextItem As UndoItem = ua
                Dim i As Integer = 0
                While i < 6
    Dim prevItem As UndoItem = UndoList(UndoList.Count - 2 - i)
                    canRemove = canRemove And (Math.Abs(prevItem.Text.Length - nextItem.Text.Length) <= 1 AndAlso Math.Abs(prevItem.Position - nextItem.Position) <= 1)
                    nextItem = prevItem
                    System.Math.Max(System.Threading.Interlocked.Increment(i), i - 1)
                End While
                If canRemove Then
                    UndoList.RemoveRange(UndoList.Count - 6, 5)
                End If
            End If
            UndoIndex = UndoList.Count
        End Sub

    Public Sub ClearUndo()
        UndoList = New List(Of UndoItem)()
        UndoIndex = 0
    End Sub

    Public Sub Undo()
        If Not CanUndo Then
            Return
        End If

        System.Math.Max(System.Threading.Interlocked.Decrement(UndoIndex), UndoIndex + 1)
        If UndoIndex < 1 Then
            UndoIndex = 1
        End If

        ' implement undo action here
        Dim ua As UndoItem = UndoList(UndoIndex - 1)
        RestoreState(ua)
    End Sub

    Public Sub Redo()
        If Not CanRedo Then
            Return
        End If

        System.Math.Max(System.Threading.Interlocked.Increment(UndoIndex), UndoIndex - 1)
        If UndoIndex > UndoList.Count Then
            UndoIndex = UndoList.Count
        End If

        Dim ua As UndoItem = UndoList(UndoIndex - 1)
        RestoreState(ua)

    End Sub

    Private Sub RestoreState(ByVal item As UndoItem)
        Lock()
        ' restore state
        Textbox.Rtf = item.Text
        Textbox.[Select](item.Position, 0)
        HScrollPos = item.ScrollPosition.X
        VScrollPos = item.ScrollPosition.Y

        Unlock()
    End Sub

    Public ReadOnly Property CanUndo() As Boolean
        Get
            Return UndoIndex > 0
        End Get
    End Property

    Public ReadOnly Property CanRedo() As Boolean
        Get
            Return UndoIndex < UndoList.Count
        End Get
    End Property

    Public Sub New(ByVal textbox As RichTextBox, ByVal scanner As Scanner, ByVal parser As Parser)
        Me.Textbox = textbox
        Me.Scanner = scanner
        Me.Parser = parser

        ClearUndo()

        AddHandler Textbox.TextChanged, AddressOf Textbox_TextChanged
        AddHandler textbox.KeyUp, AddressOf textbox_KeyDown
        AddHandler Textbox.SelectionChanged, AddressOf Textbox_SelectionChanged
        AddHandler Textbox.Disposed, AddressOf Textbox_Disposed

        Tree = New ParseTree()
        currentContext = Tree

        threadAutoHighlight = New Thread(AddressOf AutoHighlightStart)
        threadAutoHighlight.Start()
    End Sub


    Public Sub Lock()
        ' Stop redrawing:  
        SendMessage(Textbox.Handle, WM_SETREDRAW, 0, IntPtr.Zero)
        ' Stop sending of events:  
        stateLocked = SendMessage(Textbox.Handle, EM_GETEVENTMASK, 0, IntPtr.Zero)
        ' change colors and stuff in the RichTextBox  
    End Sub

    Public Sub Unlock()
        ' turn on events  
        SendMessage(Textbox.Handle, EM_SETEVENTMASK, 0, stateLocked)
        ' turn on redrawing  
        SendMessage(Textbox.Handle, WM_SETREDRAW, 1, IntPtr.Zero)

        stateLocked = IntPtr.Zero
        Textbox.Invalidate()
    End Sub

    Sub textbox_KeyDown(ByVal sender As Object, ByVal e As KeyEventArgs)

            '=============================
            If e.KeyCode = Keys.Space Then
                DoAction(Textbox.Rtf, Textbox.SelectionStart)
                HighlightText()
            End If
            '=============================

        ' undo/redo
        If e.KeyValue = 89 AndAlso e.Control Then
            Redo()
            ' CTRL-Y
        End If
        If e.KeyValue = 90 AndAlso e.Control Then
            Undo()
            ' CTRL-Z
        End If

        RaiseEvent KeyDown(sender, e)

    End Sub

    Sub Textbox_TextChanged(ByVal sender As Object, ByVal e As EventArgs)
        If stateLocked <> IntPtr.Zero Then
            Return
        End If
    End Sub

    Sub Textbox_SelectionChanged(ByVal sender As Object, ByVal e As EventArgs)
        If stateLocked <> IntPtr.Zero Then
            Return
        End If

        Dim newContext As ParseNode = GetCurrentContext()

        If currentContext Is Nothing Then
            currentContext = newContext
        End If
        If newContext Is Nothing Then
            Return
        End If

        If newContext.Token.Type <> currentContext.Token.Type Then
            RaiseEvent SwitchContext(Me, New ContextSwitchEventArgs(currentContext, newContext))
            'SwitchContext.Invoke(Me, New ContextSwitchEventArgs(currentContext, newContext))
            currentContext = newContext
        End If

    End Sub

    ''' <summary>
    ''' this handy function returns the section in which the user is editing currently
    ''' </summary>
    ''' <returns></returns>
    Public Function GetCurrentContext() As ParseNode
        Dim node As ParseNode = FindNode(Tree, Textbox.SelectionStart)
        Return node
    End Function

    Private Function FindNode(ByVal node As ParseNode, ByVal posstart As Integer) As ParseNode

        If node Is Nothing Then
            Return Nothing
        End If

        If node.Nodes.Count > 0 Then
            If node.Nodes.Count > 1 And _
                   node.Nodes(node.Nodes.Count - 1).Token.Type = TokenType._UNDETERMINED_ Then
                Return FindNode(node.Nodes(node.Nodes.Count - 2), 0)
            ElseIf node.Nodes(node.Nodes.Count - 1).Nodes.Count > 0 Then
                Return FindNode(node.Nodes(node.Nodes.Count - 1), 0)
            Else
                Return node.Nodes(node.Nodes.Count - 1)
            End If
        Else
            Return node
        End If

    End Function

    ''' <summary>
    ''' use HighlighText to start the text highlight process from the caller's thread.
    ''' this method is not used internally. 
    ''' </summary>
    Public Sub HighlightText()
        SyncLock treelock
            textChanged = True
            currentText = Trim(Textbox.Text)
        End SyncLock
    End Sub

    Private Sub HighlightTextInternal()
        ' highlight the text (used internally only)
        Lock()

        Dim hscroll As Integer = HScrollPos
        Dim vscroll As Integer = VScrollPos

        Dim selstart As Integer = Textbox.SelectionStart

        HighlighTextCore()

        Textbox.[Select](selstart, 0)

        HScrollPos = hscroll
        VScrollPos = vscroll

        Unlock()
    End Sub

    ''' <summary>
    ''' this method should be used only by HighlightText or RestoreState methods
    ''' </summary>
    Private Sub HighlighTextCore()
        'Tree = Parser.Parse(Textbox.Text);
        Dim sb As New StringBuilder()
        If Tree Is Nothing Then
            Return
        End If

            If Tree.Errors.Count > 0 Then
                Exit Sub
            End If

        Dim start As ParseNode = Tree.Nodes(0)
        HightlightNode(start, sb)

        ' append any trailing skipped tokens that were scanned
        For Each skiptoken As Token In Scanner.Skipped
            HighlightToken(skiptoken, sb)
            sb.Append(skiptoken.Text.Replace("\", "\\").Replace("{", "\{").Replace("}", "\}").Replace(vbLf, "\par" & vbLf))
        Next

        sb = Unicode(sb)     ' <--- without this, unicode characters will be garbled after highlighting

        AddRtfHeader(sb)
        AddRtfEnd(sb)

        Textbox.Rtf = sb.ToString()

    End Sub


    ''' <summary>
    ''' added function to convert unicode characters in the stringbuilder to rtf unicode escapes
    ''' </summary>
    Function Unicode(ByVal sb As StringBuilder) As StringBuilder

        Dim i As Integer
        Dim uc As StringBuilder = New StringBuilder
        For i = 0 To sb.Length - 1
            Dim c As Char = sb(i)
            If AscW(c) < 127 Then
                uc.Append(c.ToString())
            Else
                uc.Append("\u" & CStr(AscW(c)) + "?")
            End If
        Next

        Return uc

    End Function

    ' thread start for the automatic highlighting
    Private Shared treelock As New Object()
    Private isDisposing As Boolean
    Private textChanged As Boolean
    Private currentText As String

    Private Sub AutoHighlightStart()
        Dim _tree As ParseTree
        Dim _currenttext As String = ""
        While Not isDisposing
            Dim _textchanged As Boolean
            SyncLock treelock
                _textchanged = textChanged
                If textChanged Then
                    textChanged = False
                    _currenttext = currentText
                End If
            End SyncLock
            If Not _textchanged Then
                Thread.Sleep(200)
                Continue While
            End If

            _tree = DirectCast(Parser.Parse(_currenttext), ParseTree)

            SyncLock treelock
                If textChanged Then
                    Continue While
                Else
                    ' assign new tree
                    Tree = _tree
                End If
            End SyncLock


            Textbox.Invoke(New MethodInvoker(AddressOf HighlightTextInternal))
        End While
    End Sub


    ''' <summary>
    ''' inserts the RTF codes to highlight text blocks
    ''' </summary>
    ''' <param name="node">the node to highlight, will be appended to sb</param>
    ''' <param name="sb">the final output string</param>
    Private Sub HightlightNode(ByVal node As ParseNode, ByVal sb As StringBuilder)
        If node.Nodes.Count = 0 Then
            If (node.Token.Skipped IsNot Nothing) Then
                For Each skiptoken As Token In node.Token.Skipped
                    HighlightToken(skiptoken, sb)
                    sb.Append(skiptoken.Text.Replace("\", "\\").Replace("{", "\{").Replace("}", "\}").Replace(vbLf, "\par" & vbLf))
                Next
            End If

            HighlightToken(node.Token, sb)
            sb.Append(node.Token.Text.Replace("\", "\\").Replace("{", "\{").Replace("}", "\}").Replace("" & Chr(10) & "", "\par" & Chr(10) & ""))
            sb.Append("}")
        End If

        For Each n As ParseNode In node.Nodes
            HightlightNode(n, sb)
        Next
    End Sub

    ''' <summary>
    ''' inserts the RTF codes to highlight text blocks
    ''' </summary>
    ''' <param name="token">the token to highlight, will be appended to sb</param>
    ''' <param name="sb">the final output string</param>
    Private Sub HighlightToken(ByVal token As Token, ByVal sb As StringBuilder)
        Select Case token.Type
                    Case TokenType.BROPEN:
                        sb.Append("{{\cf1 ")
                        Exit Select
                    Case TokenType.BRCLOSE:
                        sb.Append("{{\cf2 ")
                        Exit Select
                    Case TokenType.CARRET:
                        sb.Append("{{\cf3 ")
                        Exit Select
                    Case TokenType.COLON:
                        sb.Append("{{\cf4 ")
                        Exit Select
                    Case TokenType.COMMA:
                        sb.Append("{{\cf5 ")
                        Exit Select
                    Case TokenType.DATABASENAME:
                        sb.Append("{{\cf6 ")
                        Exit Select
                    Case TokenType.DATABASETYPE:
                        sb.Append("{{\cf7 ")
                        Exit Select
                    Case TokenType.EMAILADDRESS:
                        sb.Append("{{\cf8 ")
                        Exit Select
                    Case TokenType.EQUALS:
                        sb.Append("{{\cf9 ")
                        Exit Select
                    Case TokenType.FILELOCATIONNAME:
                        sb.Append("{{\cf10 ")
                        Exit Select
                    Case TokenType.FOLLOWINGREADINGTEXT:
                        sb.Append("{{\cf11 ")
                        Exit Select
                    Case TokenType.IDENTIFIER:
                        sb.Append("{{\cf12 ")
                        Exit Select
                    Case TokenType.MATHFUNCTION:
                        sb.Append("{{\cf13 ")
                        Exit Select
                    Case TokenType.MODELELEMENTNAME:
                        sb.Append("{{\cf14 ")
                        Exit Select
                    Case TokenType.MODELELEMENTSUFFIX:
                        sb.Append("{{\cf15 ")
                        Exit Select
                    Case TokenType.NUMBER:
                        sb.Append("{{\cf16 ")
                        Exit Select
                    Case TokenType.PREBOUNDREADINGTEXT:
                        sb.Append("{{\cf17 ")
                        Exit Select
                    Case TokenType.POSTBOUNDREADINGTEXT:
                        sb.Append("{{\cf18 ")
                        Exit Select
                    Case TokenType.PREDICATE:
                        sb.Append("{{\cf19 ")
                        Exit Select
                    Case TokenType.REFERENCEMODE:
                        sb.Append("{{\cf20 ")
                        Exit Select
                    Case TokenType.ROLENAME:
                        sb.Append("{{\cf21 ")
                        Exit Select
                    Case TokenType.SEMICOLON:
                        sb.Append("{{\cf22 ")
                        Exit Select
                    Case TokenType.SINGLEQUOTE:
                        sb.Append("{{\cf23 ")
                        Exit Select
                    Case TokenType.SPACE:
                        sb.Append("{{\cf24 ")
                        Exit Select
                    Case TokenType.VALUE:
                        sb.Append("{{\cf25 ")
                        Exit Select
                    Case TokenType.KEYWDA:
                        sb.Append("{{\cf26 ")
                        Exit Select
                    Case TokenType.KEYWDAN:
                        sb.Append("{{\cf27 ")
                        Exit Select
                    Case TokenType.KEYWDAND:
                        sb.Append("{{\cf28 ")
                        Exit Select
                    Case TokenType.KEYWDADD:
                        sb.Append("{{\cf29 ")
                        Exit Select
                    Case TokenType.KEYWDADDFACT:
                        sb.Append("{{\cf30 ")
                        Exit Select
                    Case TokenType.KEYWDADDFACTTYPE:
                        sb.Append("{{\cf31 ")
                        Exit Select
                    Case TokenType.KEYWDASSERT:
                        sb.Append("{{\cf32 ")
                        Exit Select
                    Case TokenType.KEYWDATMOSTONE:
                        sb.Append("{{\cf33 ")
                        Exit Select
                    Case TokenType.KEYWDBUTNOTBOTH:
                        sb.Append("{{\cf34 ")
                        Exit Select
                    Case TokenType.KEYWDCOMBINATION:
                        sb.Append("{{\cf35 ")
                        Exit Select
                    Case TokenType.KEYWDCOUNT:
                        sb.Append("{{\cf36 ")
                        Exit Select
                    Case TokenType.KEYWDCOUNTSTAR:
                        sb.Append("{{\cf37 ")
                        Exit Select
                    Case TokenType.KEYWDCREATE:
                        sb.Append("{{\cf38 ")
                        Exit Select
                    Case TokenType.KEYWDCREATECONCEPT:
                        sb.Append("{{\cf39 ")
                        Exit Select
                    Case TokenType.KEYWDDATABASE:
                        sb.Append("{{\cf40 ")
                        Exit Select
                    Case TokenType.KEYWDCREATEENTITYTYPE:
                        sb.Append("{{\cf41 ")
                        Exit Select
                    Case TokenType.KEYWDCREATEFACTTYPE:
                        sb.Append("{{\cf42 ")
                        Exit Select
                    Case TokenType.KEYWDCREATEMODEL:
                        sb.Append("{{\cf43 ")
                        Exit Select
                    Case TokenType.KEYWDCREATEVALUETYPE:
                        sb.Append("{{\cf44 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPELOGICALTRUEFALSE:
                        sb.Append("{{\cf45 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPELOGICALYESNO:
                        sb.Append("{{\cf46 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEAUTOCOUNTER:
                        sb.Append("{{\cf47 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEDECIMAL:
                        sb.Append("{{\cf48 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEFLOATCUSTOMPRECISION:
                        sb.Append("{{\cf49 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEFLOATDOUBLEPRECISION:
                        sb.Append("{{\cf50 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEFLOATSINGLEPRECISION:
                        sb.Append("{{\cf51 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEMONEY:
                        sb.Append("{{\cf52 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPESIGNEDBIGINTEGER:
                        sb.Append("{{\cf53 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPESIGNEDINTEGER:
                        sb.Append("{{\cf54 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPESIGNEDSMALLINTEGER:
                        sb.Append("{{\cf55 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEUNSIGNEDBIGINTEGER:
                        sb.Append("{{\cf56 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEUNSIGNEDINTEGER:
                        sb.Append("{{\cf57 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEUNSIGNEDSMALLINTEGER:
                        sb.Append("{{\cf58 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEUNSIGNEDTINYINTEGER:
                        sb.Append("{{\cf59 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEOBJECTID:
                        sb.Append("{{\cf60 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEROWID:
                        sb.Append("{{\cf61 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPERAWDATAFIXEDLENGTH:
                        sb.Append("{{\cf62 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPERAWDATALARGELENGTH:
                        sb.Append("{{\cf63 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPERAWDATAOLEOBJECT:
                        sb.Append("{{\cf64 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPERAWDATA:
                        sb.Append("{{\cf65 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPERAWDATAVARIABLELENGTH:
                        sb.Append("{{\cf66 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEAUTOTIMESTAMP:
                        sb.Append("{{\cf67 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEDATE:
                        sb.Append("{{\cf68 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPEDATETIME:
                        sb.Append("{{\cf69 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPETIME:
                        sb.Append("{{\cf70 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPESTRINGFIXEDLENGTH:
                        sb.Append("{{\cf71 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPESTRINGLARGELENGTH:
                        sb.Append("{{\cf72 ")
                        Exit Select
                    Case TokenType.KEYWDDATATYPESTRINGVARIABLELENGTH:
                        sb.Append("{{\cf73 ")
                        Exit Select
                    Case TokenType.KEYWDDELETE:
                        sb.Append("{{\cf74 ")
                        Exit Select
                    Case TokenType.KEYWDDELETEALL:
                        sb.Append("{{\cf75 ")
                        Exit Select
                    Case TokenType.KEYWDDELETEFACT:
                        sb.Append("{{\cf76 ")
                        Exit Select
                    Case TokenType.KEYWDDESCRIBE:
                        sb.Append("{{\cf77 ")
                        Exit Select
                    Case TokenType.KEYWDDID:
                        sb.Append("{{\cf78 ")
                        Exit Select
                    Case TokenType.KEYWDDISTINCT:
                        sb.Append("{{\cf79 ")
                        Exit Select
                    Case TokenType.KEYWDEACH:
                        sb.Append("{{\cf80 ")
                        Exit Select
                    Case TokenType.KEYWDEITHER:
                        sb.Append("{{\cf81 ")
                        Exit Select
                    Case TokenType.KEYWDENTITY:
                        sb.Append("{{\cf82 ")
                        Exit Select
                    Case TokenType.KEYWDENTITYTYPE:
                        sb.Append("{{\cf83 ")
                        Exit Select
                    Case TokenType.KEYWDENTITYTYPES:
                        sb.Append("{{\cf84 ")
                        Exit Select
                    Case TokenType.KEYWDENUMERATE:
                        sb.Append("{{\cf85 ")
                        Exit Select
                    Case TokenType.KEYWDEXISTS:
                        sb.Append("{{\cf86 ")
                        Exit Select
                    Case TokenType.KEYWDFACT:
                        sb.Append("{{\cf87 ")
                        Exit Select
                    Case TokenType.KEYWDFACTTYPE:
                        sb.Append("{{\cf88 ")
                        Exit Select
                    Case TokenType.KEYWDFACTTYPES:
                        sb.Append("{{\cf89 ")
                        Exit Select
                    Case TokenType.KEYWDFOR:
                        sb.Append("{{\cf90 ")
                        Exit Select
                    Case TokenType.KEYWDFOREACH:
                        sb.Append("{{\cf91 ")
                        Exit Select
                    Case TokenType.KEYWDFROM:
                        sb.Append("{{\cf92 ")
                        Exit Select
                    Case TokenType.KEYWDGET:
                        sb.Append("{{\cf93 ")
                        Exit Select
                    Case TokenType.KEYWDIFANDONLYIF:
                        sb.Append("{{\cf94 ")
                        Exit Select
                    Case TokenType.KEYWDIN:
                        sb.Append("{{\cf95 ")
                        Exit Select
                    Case TokenType.KEYWDINSERT:
                        sb.Append("{{\cf96 ")
                        Exit Select
                    Case TokenType.KEYWDINTO:
                        sb.Append("{{\cf97 ")
                        Exit Select
                    Case TokenType.KEYWDIS:
                        sb.Append("{{\cf98 ")
                        Exit Select
                    Case TokenType.KEYWDISA:
                        sb.Append("{{\cf99 ")
                        Exit Select
                    Case TokenType.KEYWDISAKINDOF:
                        sb.Append("{{\cf100 ")
                        Exit Select
                    Case TokenType.KEYWDISIDENTIFIEDBYITS:
                        sb.Append("{{\cf101 ")
                        Exit Select
                    Case TokenType.KEYWDISNOT:
                        sb.Append("{{\cf102 ")
                        Exit Select
                    Case TokenType.KEYWDISWHERE:
                        sb.Append("{{\cf103 ")
                        Exit Select
                    Case TokenType.KEYWDISWRITTENAS:
                        sb.Append("{{\cf104 ")
                        Exit Select
                    Case TokenType.KEYWDITISMANDATORYTHAT:
                        sb.Append("{{\cf105 ")
                        Exit Select
                    Case TokenType.KEYWDJOINING:
                        sb.Append("{{\cf106 ")
                        Exit Select
                    Case TokenType.KEYWDINDEX:
                        sb.Append("{{\cf107 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGE:
                        sb.Append("{{\cf108 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGEDFD:
                        sb.Append("{{\cf109 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGEERD:
                        sb.Append("{{\cf110 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGEETD:
                        sb.Append("{{\cf111 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGEORM:
                        sb.Append("{{\cf112 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGESTD:
                        sb.Append("{{\cf113 ")
                        Exit Select
                    Case TokenType.KEYWDLANGUAGEUCD:
                        sb.Append("{{\cf114 ")
                        Exit Select
                    Case TokenType.KEYWDLOCATION:
                        sb.Append("{{\cf115 ")
                        Exit Select
                    Case TokenType.KEYWDLIST:
                        sb.Append("{{\cf116 ")
                        Exit Select
                    Case TokenType.KEYWDMATCH:
                        sb.Append("{{\cf117 ")
                        Exit Select
                    Case TokenType.KEYWDMODEL:
                        sb.Append("{{\cf118 ")
                        Exit Select
                    Case TokenType.KEYWDMODELNOTES:
                        sb.Append("{{\cf119 ")
                        Exit Select
                    Case TokenType.KEYWDMODELDICTIONARY:
                        sb.Append("{{\cf120 ")
                        Exit Select
                    Case TokenType.KEYWDNULL:
                        sb.Append("{{\cf121 ")
                        Exit Select
                    Case TokenType.KEYWDOBJECT:
                        sb.Append("{{\cf122 ")
                        Exit Select
                    Case TokenType.KEYWDOCCURSATLEASTONETIME:
                        sb.Append("{{\cf123 ")
                        Exit Select
                    Case TokenType.KEYWDOCCURSATLEASTONETIMEINEACHOF:
                        sb.Append("{{\cf124 ")
                        Exit Select
                    Case TokenType.KEYWDOF:
                        sb.Append("{{\cf125 ")
                        Exit Select
                    Case TokenType.KEYWDON:
                        sb.Append("{{\cf126 ")
                        Exit Select
                    Case TokenType.KEYWDONE:
                        sb.Append("{{\cf127 ")
                        Exit Select
                    Case TokenType.KEYWDONPAGE:
                        sb.Append("{{\cf128 ")
                        Exit Select
                    Case TokenType.KEYWDOPEN:
                        sb.Append("{{\cf129 ")
                        Exit Select
                    Case TokenType.KEYWDOR:
                        sb.Append("{{\cf130 ")
                        Exit Select
                    Case TokenType.KEYWDPAGE:
                        sb.Append("{{\cf131 ")
                        Exit Select
                    Case TokenType.KEYWDPREDICATE:
                        sb.Append("{{\cf132 ")
                        Exit Select
                    Case TokenType.KEYWDRETURN:
                        sb.Append("{{\cf133 ")
                        Exit Select
                    Case TokenType.KEYWDROLE:
                        sb.Append("{{\cf134 ")
                        Exit Select
                    Case TokenType.KEYWDSELECT:
                        sb.Append("{{\cf135 ")
                        Exit Select
                    Case TokenType.KEYWDRESTRICTEDTO:
                        sb.Append("{{\cf136 ")
                        Exit Select
                    Case TokenType.KEYWDROLECONSTRAINTS:
                        sb.Append("{{\cf137 ")
                        Exit Select
                    Case TokenType.KEYWDSET:
                        sb.Append("{{\cf138 ")
                        Exit Select
                    Case TokenType.KEYWDSHOW:
                        sb.Append("{{\cf139 ")
                        Exit Select
                    Case TokenType.KEYWDSUPERTYPE:
                        sb.Append("{{\cf140 ")
                        Exit Select
                    Case TokenType.KEYWDTHAT:
                        sb.Append("{{\cf141 ")
                        Exit Select
                    Case TokenType.KEYWDTO:
                        sb.Append("{{\cf142 ")
                        Exit Select
                    Case TokenType.KEYWDTYPE:
                        sb.Append("{{\cf143 ")
                        Exit Select
                    Case TokenType.KEYWDUPDATE:
                        sb.Append("{{\cf144 ")
                        Exit Select
                    Case TokenType.KEYWDVALUES:
                        sb.Append("{{\cf145 ")
                        Exit Select
                    Case TokenType.KEYWDVALUETYPE:
                        sb.Append("{{\cf146 ")
                        Exit Select
                    Case TokenType.KEYWDVALUETYPES:
                        sb.Append("{{\cf147 ")
                        Exit Select
                    Case TokenType.KEYWDWHEN:
                        sb.Append("{{\cf148 ")
                        Exit Select
                    Case TokenType.KEYWDWHERE:
                        sb.Append("{{\cf149 ")
                        Exit Select
                    Case TokenType.KEYWDWITH:
                        sb.Append("{{\cf150 ")
                        Exit Select
                    Case TokenType.KEYWDWHAT:
                        sb.Append("{{\cf151 ")
                        Exit Select
                    Case TokenType.KEYWDWHICH:
                        sb.Append("{{\cf152 ")
                        Exit Select
                    Case TokenType.KEYWDWRITTENAS:
                        sb.Append("{{\cf153 ")
                        Exit Select
                    Case TokenType.EXPRESSIONSYMBOL:
                        sb.Append("{{\cf154 ")
                        Exit Select

            Case Else
                sb.Append("{{\cf0 ")
                Exit Select
        End Select
    End Sub

    ' define the color palette to be used here
    Private Sub AddRtfHeader(ByVal sb As StringBuilder)
        sb.Insert(0, "{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 Tahoma;}}{\colortbl;\red94\green213\blue165;\red94\green213\blue165;\red94\green213\blue165;\red94\green213\blue165;\red135\green207\blue243;\red227\green143\blue247;\red227\green143\blue247;\red216\green127\blue178;\red135\green207\blue243;\red227\green143\blue247;\red227\green143\blue247;\red216\green127\blue178;\red216\green127\blue178;\red94\green213\blue165;\red94\green213\blue165;\red216\green127\blue178;\red94\green213\blue165;\red94\green213\blue165;\red227\green143\blue247;\red76\green153\blue0;\red153\green76\blue0;\red227\green143\blue247;\red216\green127\blue178;\red0\green0\blue255;\red153\green0\blue0;\red115\green217\blue243;\red115\green217\blue243;\red115\green217\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red115\green217\blue243;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red200\green200\blue200;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red115\green217\blue243;\red0\green0\blue255;\red135\green207\blue243;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red135\green207\blue243;\red135\green207\blue243;\red135\green207\blue243;\red135\green207\blue243;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red135\green207\blue243;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red0\green0\blue255;\red135\green207\blue243;\red135\green207\blue243;\red135\green207\blue243;\red135\green207\blue243;\red94\green213\blue165;}\viewkind4\uc1\pard\lang1033\f0\fs20")
    End Sub

    Private Sub AddRtfEnd(ByVal sb As StringBuilder)
        sb.Append("} ")
    End Sub

    Sub Textbox_Disposed(ByVal sender As Object, ByVal e As EventArgs)
        Dispose()
    End Sub

#Region "IDisposable Members"

    Public Sub Dispose() Implements IDisposable.Dispose
        isDisposing = True
        threadAutoHighlight.Join(1000)
        If threadAutoHighlight.IsAlive Then
            threadAutoHighlight.Abort()
        End If
    End Sub

#End Region

    End Class
End Namespace
